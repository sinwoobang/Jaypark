{% extends "feed/base.html" %}
{% load staticfiles %}
{% load common_filters %}
{% block content %}
<div>
    <div>
        <label for="text-username-to-follow">Follow : </label>
        <input type="text" id="text-username-to-follow" name="username" />
        <button class="btn btn-primary" type="button" id="btn-follow">Follow</button>
    </div>
    <div class='form-group'>
        <label for='text-post'></label>
        <textarea class='form-control' id='text-post' placeholder="Let's tweet!"></textarea>
        <button class='btn btn-primary' type='button' id='btn-post'>Tweet</button>
    </div>
    <hr>
    <h3>Tweets</h3>
    <hr>
    <div>
        {% for tweet in feed_tweets %}
            <div id="tweet-{{ tweet.tweet_id }}" class="tweet">
                <p>{{ tweet.text }}<p>
                <span>Tweet By <span><a href="{{ tweet.username|username2url }}">{{ tweet.username }}</a></span></span>
                <span>{{ tweet.created_at|timestamp2datetime }}</span>
                {% if not tweet.is_liked %}
                    <button class="btn btn-primary tweet--btn-like" data-tweet-id="{{ tweet.tweet_id }}">Like</button>
                {% else %}
                    <button class="btn btn-primary tweet--btn-unlike disabled" data-tweet-id="{{ tweet.tweet_id }}">UnLike</button>
                {% endif %}

                <div>
                    <textarea type="text" class="tweet--text-comment" id="text-tweet-{{ tweet.tweet_id }}"></textarea>
                    <button class="btn btn-primary tweet--btn-comment" data-tweet-id="{{ tweet.tweet_id }}">Comment</button>
                    <div>
                        <span class="anchor anchor-text no-global-action tweet--anchor-load-comments" data-tweet-id="{{ tweet.tweet_id }}">
                            See comments
                        </span>
                        <div class="tweet--content-comments"></div>
                    </div>
                </div>
            </div>
            <hr>
        {% endfor %}
    </div>
</div>
<script>
    $(document).ready(function() {
      $('#btn-post').click(function() {
        var text = $('#text-post').val();
        var postData = {
          text: text
        };
        sendPostRequestWithJson('{% url 'post.api.write' %}', postData, function(res) {
          if (res.status === 'success') {
            alert('Success.');
            document.location.reload();
          } else {
            alert('Failed.');
          }
        });
      });

      $('#btn-follow').click(function() {
        var username = $('#text-username-to-follow').val();
        var postData = {
            key: 'username',
            username: username
        };
        sendPostRequestWithJson('{% url 'account.api.follow' %}', postData, function(res) {
          if (res.status === 'success') {
            alert('Success.');
            document.location.reload();
            } else {
                alert(res.status_message);
            }
        });
      });

      $('.tweet--btn-like').click(function() {
        var tweetId = $(this).data('tweet-id');
        var postData = {
            tweet_id: tweetId
        };
        sendPostRequestWithJson('{% url 'post.api.like' %}', postData, function(res) {
          if (res.status === 'success') {
            alert('Success.');
            document.location.reload();
            } else {
                alert(res.status_message);
            }
        });
      });

      $('.tweet--btn-unlike').click(function() {
        var tweetId = $(this).data('tweet-id');
        var postData = {
            tweet_id: tweetId
        };
        sendPostRequestWithJson('{% url 'post.api.unlike' %}', postData, function(res) {
          if (res.status === 'success') {
            alert('Success.');
            document.location.reload();
            } else {
                alert(res.status_message);
            }
        });
      });

      $('.tweet--btn-comment').on('click', function() {
        var tweetId = $(this).data('tweet-id');
        var textDomId = '#text-tweet-' + tweetId;
        var text = $(textDomId).val();
        var postData = {
          tweet_id: tweetId,
          text: text
        };
        sendPostRequestWithJson('{% url 'post.api.write_comment' %}', postData, function(res) {
          if (res.status === 'success') {
            alert(res.status_message);
            document.location.reload();
          } else {
            alert(res.status_message);
          }
        });
      })
    });
</script>
{% endblock %}