{% extends "feed/base.html" %}
{% load staticfiles %}
{% load common_filters %}
{% block content %}
<div class="row">
    <div class="col">
        <div>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">@{{ user.username }}</h5>
                    <p class="card-text">Following : {{ number_followings }}</p>
                    <p class="card-text">Followers : {{ number_followeds }}</p>
                </div>
            </div>
    </div>
</div>
<div class="col-7">
    <div class="form-group">
        <form id="form-account-update" enctype="multipart/form-data">
            <input type="file" class="form-control-file" id="file-profile-photo">
        </form>
    </div>
    <div>
        <label for="text-username-to-follow">Follow : </label>
        <input type="text" id="text-username-to-follow" name="username" />
        <button class="btn btn-primary" type="button" id="btn-follow">Follow</button>
    </div>
    <div class='form-group'>
        <label for='text-post'></label>
        <textarea class='form-control' id='text-post' placeholder="Let's tweet!"></textarea>
        <button class='btn btn-primary' type='button' id='btn-post'>Tweet</button>
    </div>
    <hr>
    <h3>Tweets</h3>
    <hr>
    <div>
        {% for tweet in feed_tweets %}
            <div id="tweet-{{ tweet.tweet_id }}" class="tweet">
                <p>{{ tweet.text }}<p>
                <span>Tweet By <span><a href="{{ tweet.username|username2url }}">{{ tweet.username }}</a></span></span>
                <span>{{ tweet.created_at|timestamp2datetime }}</span>
                {% if not tweet.is_liked %}
                    <button class="btn btn-primary tweet--btn-like" data-tweet-id="{{ tweet.tweet_id }}">Like</button>
                {% else %}
                    <button class="btn btn-primary tweet--btn-unlike disabled" data-tweet-id="{{ tweet.tweet_id }}">UnLike</button>
                {% endif %}

                <div>
                    <textarea type="text" class="tweet--text-comment" id="text-tweet-{{ tweet.tweet_id }}"></textarea>
                    <button class="btn btn-primary tweet--btn-comment" data-tweet-id="{{ tweet.tweet_id }}">Comment</button>
                    <div>
                        <span class="anchor anchor-text no-global-action tweet--anchor-load-comments" data-tweet-id="{{ tweet.tweet_id }}">
                            See comments
                        </span>
                        <div class="tweet--content-comments"></div>
                    </div>
                </div>
            </div>
            <hr>
        {% endfor %}
    </div>
</div>
<div class="col"></div>
</div>
<script>
    $(document).ready(function() {
      $('#btn-post').click(function() {
        var text = $('#text-post').val();
        var postData = {
          text: text
        };
        sendPostRequestWithJson('{% url 'post.api.write' %}', postData, function(res) {
          if (res.status === 'success') {
            alert('Success.');
            document.location.reload();
          } else {
            alert('Failed.');
          }
        });
      });

      $('#btn-follow').click(function() {
        var username = $('#text-username-to-follow').val();
        var postData = {
            key: 'username',
            username: username
        };
        sendPostRequestWithJson('{% url 'account.api.follow' %}', postData, function(res) {
          if (res.status === 'success') {
            alert('Success.');
            document.location.reload();
            } else {
                alert(res.status_message);
            }
        });
      });

      $('.tweet--btn-like').click(function() {
        var tweetId = $(this).data('tweet-id');
        var postData = {
            tweet_id: tweetId
        };
        sendPostRequestWithJson('{% url 'post.api.like' %}', postData, function(res) {
          if (res.status === 'success') {
            alert('Success.');
            document.location.reload();
            } else {
                alert(res.status_message);
            }
        });
      });

      $('.tweet--btn-unlike').click(function() {
        var tweetId = $(this).data('tweet-id');
        var postData = {
            tweet_id: tweetId
        };
        sendPostRequestWithJson('{% url 'post.api.unlike' %}', postData, function(res) {
          if (res.status === 'success') {
            alert('Success.');
            document.location.reload();
            } else {
                alert(res.status_message);
            }
        });
      });

      $('.tweet--btn-comment').on('click', function() {
        var tweetId = $(this).data('tweet-id');
        var textDomId = '#text-tweet-' + tweetId;
        var text = $(textDomId).val();
        var postData = {
          tweet_id: tweetId,
          text: text
        };
        sendPostRequestWithJson('{% url 'post.api.write_comment' %}', postData, function(res) {
          if (res.status === 'success') {
            alert(res.status_message);
            document.location.reload();
          } else {
            alert(res.status_message);
          }
        });
      });

      var $fileProfilePhoto = $('#file-profile-photo');
      $fileProfilePhoto.on('change', function(e) {
        var $this = $(e.currentTarget);
        var val = $this.val();
        if (!val) {
          return false;
        }
        var allowedExtensions = ['jpeg', 'jpg', 'png'];
        var lastIndexOfReverseSlash = val.lastIndexOf("\\");
        var filename = val.substring(lastIndexOfReverseSlash+1);
        console.info('Filename : '+ filename);

        var lastIndexOfDot = filename.lastIndexOf('.');
        if (lastIndexOfDot > -1) {
          var extension = filename.substring(lastIndexOfDot+1).toLowerCase();
          if (allowedExtensions.indexOf(extension) === -1) {
            alert('Only ' + allowedExtensions.join(', ') + ' are allowed.');
            $this.val('');
            return false;
          }
        }

        var form = $('#form-account-update');
        var formData = new FormData(form);
        formData.append('file', e.currentTarget.files[0]);

        $.ajax({
          type : "POST",
          url : "{% url 'account.api.update' %}",
          processData: false,
          contentType: false,
          cache : false,
          beforeSend: function(request) {
            request.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
          },
          data : formData,
          success : function(res) {
            console.info(res.contents);
            $('#img-profile-photo').attr('src', res.contents.profile_photo_url)
          }
        });
      });
    });
</script>
{% endblock %}